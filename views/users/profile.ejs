<% layout('layouts/boilerplate.ejs') %>

<div class="container-fluid py-5" style="min-height: 100vh; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-10">
        <!-- Profile Header -->
        <div class="card shadow-lg border-0 rounded-4 mb-4" style="animation: slideInUp 0.8s ease-out;">
          <div class="card-header bg-gradient text-white text-center py-4" style="background: linear-gradient(135deg, #fe424d 0%, #e03e45 100%);">
            <div class="row align-items-center">
              <div class="col-md-3 text-center mb-3 mb-md-0">
                <div class="position-relative d-inline-block">
                  <img 
                    src="<%= user.profileImage %>" 
                    alt="Profile Picture" 
                    class="rounded-circle shadow-lg" 
                    style="width: 120px; height: 120px; object-fit: cover; border: 4px solid rgba(255,255,255,0.3);"
                  />
                  <button 
                    class="btn btn-light btn-sm position-absolute bottom-0 end-0 rounded-circle shadow-sm" 
                    style="width: 35px; height: 35px; padding: 0;"
                    data-bs-toggle="modal" 
                    data-bs-target="#profileImageModal"
                    title="Change Profile Picture"
                  >
                    <i class="fas fa-camera text-primary"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-9 text-center text-md-start">
                <h2 class="fw-bold mb-1">
                  <%= user.firstName || user.username %> <%= user.lastName || '' %>
                </h2>
                <p class="mb-2 opacity-75">
                  <i class="fas fa-envelope me-2"></i><%= user.email %>
                </p>
                <% if (user.location) { %>
                <p class="mb-2 opacity-75">
                  <i class="fas fa-map-marker-alt me-2"></i><%= user.location %>
                </p>
                <% } %>
                <p class="mb-0 opacity-75">
                  <i class="fas fa-calendar me-2"></i>Member since <%= new Date(user.joinDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long' }) %>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Profile Content -->
        <div class="row">
          <!-- Profile Information -->
          <div class="col-md-8">
            <div class="card shadow-lg border-0 rounded-4 mb-4" style="animation: slideInLeft 0.8s ease-out 0.2s both;">
              <div class="card-header bg-white border-0 py-3">
                <h4 class="mb-0 fw-bold text-dark">
                  <i class="fas fa-user-edit me-2 text-primary"></i>Profile Information
                </h4>
              </div>
              <div class="card-body p-4">
                <form action="/profile" method="POST" class="needs-validation" novalidate>
                  
                  <div class="row g-3">
                    <!-- First Name -->
                    <div class="col-md-6">
                      <label for="firstName" class="form-label fw-medium text-dark">
                        <i class="fas fa-user me-2 text-primary"></i>First Name
                      </label>
                      <input
                        type="text"
                        name="firstName"
                        id="firstName"
                        class="form-control form-control-lg border-2 rounded-3"
                        value="<%= user.firstName || '' %>"
                        placeholder="Enter your first name"
                        style="border-color: #e9ecef; transition: all 0.3s ease;"
                        onfocus="this.style.borderColor='#fe424d'; this.style.boxShadow='0 0 0 0.2rem rgba(254, 66, 77, 0.25)'"
                        onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                      />
                    </div>

                    <!-- Last Name -->
                    <div class="col-md-6">
                      <label for="lastName" class="form-label fw-medium text-dark">
                        <i class="fas fa-user me-2 text-primary"></i>Last Name
                      </label>
                      <input
                        type="text"
                        name="lastName"
                        id="lastName"
                        class="form-control form-control-lg border-2 rounded-3"
                        value="<%= user.lastName || '' %>"
                        placeholder="Enter your last name"
                        style="border-color: #e9ecef; transition: all 0.3s ease;"
                        onfocus="this.style.borderColor='#fe424d'; this.style.boxShadow='0 0 0 0.2rem rgba(254, 66, 77, 0.25)'"
                        onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                      />
                    </div>

                    <!-- Email -->
                    <div class="col-md-6">
                      <label for="email" class="form-label fw-medium text-dark">
                        <i class="fas fa-envelope me-2 text-primary"></i>Email Address
                      </label>
                      <input
                        type="email"
                        name="email"
                        id="email"
                        class="form-control form-control-lg border-2 rounded-3"
                        value="<%= user.email %>"
                        placeholder="example@email.com"
                        required
                        style="border-color: #e9ecef; transition: all 0.3s ease;"
                        onfocus="this.style.borderColor='#fe424d'; this.style.boxShadow='0 0 0 0.2rem rgba(254, 66, 77, 0.25)'"
                        onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                      />
                    </div>

                    <!-- Phone -->
                    <div class="col-md-6">
                      <label for="phone" class="form-label fw-medium text-dark">
                        <i class="fas fa-phone me-2 text-primary"></i>Phone Number
                      </label>
                      <input
                        type="tel"
                        name="phone"
                        id="phone"
                        class="form-control form-control-lg border-2 rounded-3"
                        value="<%= user.phone || '' %>"
                        placeholder="Enter your phone number"
                        style="border-color: #e9ecef; transition: all 0.3s ease;"
                        onfocus="this.style.borderColor='#fe424d'; this.style.boxShadow='0 0 0 0.2rem rgba(254, 66, 77, 0.25)'"
                        onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                      />
                    </div>

                    <!-- Location -->
                    <div class="col-md-6">
                      <label for="location" class="form-label fw-medium text-dark">
                        <i class="fas fa-map-marker-alt me-2 text-primary"></i>Location
                      </label>
                      <input
                        type="text"
                        name="location"
                        id="location"
                        class="form-control form-control-lg border-2 rounded-3"
                        value="<%= user.location || '' %>"
                        placeholder="Enter your location"
                        style="border-color: #e9ecef; transition: all 0.3s ease;"
                        onfocus="this.style.borderColor='#fe424d'; this.style.boxShadow='0 0 0 0.2rem rgba(254, 66, 77, 0.25)'"
                        onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                      />
                    </div>

                    <!-- Username -->
                    <div class="col-md-6">
                      <label for="username" class="form-label fw-medium text-dark">
                        <i class="fas fa-at me-2 text-primary"></i>Username
                      </label>
                      <input
                        type="text"
                        name="username"
                        id="username"
                        class="form-control form-control-lg border-2 rounded-3"
                        value="<%= user.username %>"
                        placeholder="Enter your username"
                        required
                        style="border-color: #e9ecef; transition: all 0.3s ease;"
                        onfocus="this.style.borderColor='#fe424d'; this.style.boxShadow='0 0 0 0.2rem rgba(254, 66, 77, 0.25)'"
                        onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                      />
                      <small class="text-muted">Choose a unique username</small>
                    </div>

                    <!-- Bio -->
                    <div class="col-12">
                      <label for="bio" class="form-label fw-medium text-dark">
                        <i class="fas fa-quote-left me-2 text-primary"></i>Bio
                      </label>
                      <textarea
                        name="bio"
                        id="bio"
                        class="form-control form-control-lg border-2 rounded-3"
                        rows="4"
                        placeholder="Tell us about yourself..."
                        style="border-color: #e9ecef; transition: all 0.3s ease; resize: vertical;"
                        onfocus="this.style.borderColor='#fe424d'; this.style.boxShadow='0 0 0 0.2rem rgba(254, 66, 77, 0.25)'"
                        onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                      ><%= user.bio || '' %></textarea>
                    </div>
                  </div>

                  <!-- Submit Button -->
                  <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-danger btn-lg rounded-3 fw-bold py-3" 
                            style="background: linear-gradient(135deg, #fe424d 0%, #e03e45 100%); border: none; transition: all 0.3s ease;"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(254, 66, 77, 0.4)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                      <i class="fas fa-save me-2"></i>Update Profile
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Account Stats & Actions -->
          <div class="col-md-4">
            <!-- Account Stats -->
            <div class="card shadow-lg border-0 rounded-4 mb-4" style="animation: slideInRight 0.8s ease-out 0.4s both;">
              <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0 fw-bold text-dark">
                  <i class="fas fa-chart-bar me-2 text-primary"></i>Account Stats
                </h5>
              </div>
              <div class="card-body p-4">
                <div class="row g-3 text-center">
                  <div class="col-6">
                    <div class="p-3 bg-light rounded-3">
                      <i class="fas fa-list fa-2x text-primary mb-2"></i>
                      <h6 class="mb-1">Listings</h6>
                      <span class="fw-bold text-dark">0</span>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="p-3 bg-light rounded-3">
                      <i class="fas fa-calendar fa-2x text-success mb-2"></i>
                      <h6 class="mb-1">Bookings</h6>
                      <span class="fw-bold text-dark">0</span>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="p-3 bg-light rounded-3">
                      <i class="fas fa-star fa-2x text-warning mb-2"></i>
                      <h6 class="mb-1">Reviews</h6>
                      <span class="fw-bold text-dark">0</span>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="p-3 bg-light rounded-3">
                      <i class="fas fa-heart fa-2x text-danger mb-2"></i>
                      <h6 class="mb-1">Favorites</h6>
                      <span class="fw-bold text-dark">0</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow-lg border-0 rounded-4" style="animation: slideInRight 0.8s ease-out 0.6s both;">
              <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0 fw-bold text-dark">
                  <i class="fas fa-bolt me-2 text-primary"></i>Quick Actions
                </h5>
              </div>
              <div class="card-body p-4">
                <div class="d-grid gap-2">
                  <a href="/listings/new" class="btn btn-outline-primary btn-lg rounded-3 fw-medium">
                    <i class="fas fa-plus me-2"></i>Add New Listing
                  </a>
                  <a href="/bookings" class="btn btn-outline-success btn-lg rounded-3 fw-medium">
                    <i class="fas fa-calendar me-2"></i>View Bookings
                  </a>
                  <a href="/bank-accounts" class="btn btn-outline-warning btn-lg rounded-3 fw-medium">
                    <i class="fas fa-university me-2"></i>Bank Accounts
                  </a>
                  <a href="/payouts" class="btn btn-outline-info btn-lg rounded-3 fw-medium">
                    <i class="fas fa-money-bill-wave me-2"></i>Payouts
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Profile Image Upload Modal -->
<div class="modal fade" id="profileImageModal" tabindex="-1" aria-labelledby="profileImageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 rounded-4">
      <div class="modal-header bg-gradient text-white border-0 rounded-top-4" style="background: linear-gradient(135deg, #fe424d 0%, #e03e45 100%);">
        <h5 class="modal-title fw-bold" id="profileImageModalLabel">
          <i class="fas fa-camera me-2"></i>Change Profile Picture
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form action="/profile/upload-image" method="POST" enctype="multipart/form-data" id="profileImageForm">
          <div class="mb-4">
            <label for="profileImage" class="form-label fw-medium text-dark">
              <i class="fas fa-image me-2 text-primary"></i>Select New Profile Picture
            </label>
            <input
              type="file"
              name="profileImage"
              id="profileImage"
              class="form-control form-control-lg border-2 rounded-3"
              accept="image/*"
              required
              style="border-color: #e9ecef; transition: all 0.3s ease;"
              onchange="previewImage(this)"
            />
            <div class="form-text">
              <i class="fas fa-info-circle me-1"></i>
              Supported formats: JPG, PNG, GIF. Max size: 5MB
            </div>
          </div>
          
          <!-- Image Preview -->
          <div id="imagePreview" class="text-center mb-4" style="display: none;">
            <img id="previewImg" src="" alt="Preview" class="img-fluid rounded-3 shadow-sm" style="max-height: 200px;">
          </div>
        </form>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary rounded-3" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>Cancel
        </button>
        <button type="button" class="btn btn-danger rounded-3 fw-medium" onclick="uploadProfileImage()">
          <i class="fas fa-upload me-2"></i>Upload Image
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Image preview functionality
function previewImage(input) {
  const preview = document.getElementById('imagePreview');
  const previewImg = document.getElementById('previewImg');
  
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      previewImg.src = e.target.result;
      preview.style.display = 'block';
    }
    
    reader.readAsDataURL(input.files[0]);
  } else {
    preview.style.display = 'none';
  }
}

// Upload profile image
function uploadProfileImage() {
  const form = document.getElementById('profileImageForm');
  const fileInput = document.getElementById('profileImage');
  
  if (!fileInput.files[0]) {
    alert('Please select an image file');
    return;
  }
  
  // Show loading state
  const uploadBtn = event.target;
  const originalText = uploadBtn.innerHTML;
  uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
  uploadBtn.disabled = true;
  
  // Add a small delay to show the loading state
  setTimeout(() => {
    form.submit();
  }, 100);
}

// Form validation
(function() {
  'use strict';
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach((form) => {
    form.addEventListener('submit', (event) => {
      console.log('Form submission attempted:', form.action, form.method);
      if (!form.checkValidity()) {
        console.log('Form validation failed');
        event.preventDefault();
        event.stopPropagation();
      } else {
        console.log('Form validation passed, submitting...');
      }
      form.classList.add('was-validated');
    }, false);
  });
})();
</script>
