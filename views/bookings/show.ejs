<% layout('layouts/boilerplate.ejs') %>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h4>Booking Details</h4>
            <span
              class="badge bg-<%= booking.status === 'confirmed' ? 'success' : booking.status === 'pending' ? 'warning' : booking.status === 'cancelled' ? 'danger' : 'secondary' %> fs-6"
            >
              <%= booking.status.charAt(0).toUpperCase() +
              booking.status.slice(1) %>
            </span>
          </div>
        </div>
        <div class="card-body">
          <!-- Listing Information -->
          <div class="row mb-4">
            <div class="col-md-4">
              <img
                src="<%= booking.listing.image %>"
                class="img-fluid rounded"
                alt="<%= booking.listing.title %>"
              />
            </div>
            <div class="col-md-8">
              <h5><%= booking.listing.title %></h5>
              <p class="text-muted">
                <i class="fas fa-map-marker-alt"></i> <%=
                booking.listing.location %>, <%= booking.listing.country %>
              </p>
              <p class="text-muted">
                <i class="fas fa-bed"></i> <%= booking.listing.bedrooms %>
                bedroom(s) • <i class="fas fa-bath"></i> <%=
                booking.listing.bathrooms %> bathroom(s) •
                <i class="fas fa-users"></i> Up to <%= booking.listing.capacity
                %> guests
              </p>
              <h6 class="text-primary">
                ₹<%= booking.listing.price.toLocaleString("en-IN") %> /night
              </h6>
            </div>
          </div>

          <!-- Booking Details -->
          <div class="row">
            <div class="col-md-6">
              <h6>Stay Details</h6>
              <div class="mb-3">
                <small class="text-muted">Check-in Date</small><br />
                <strong
                  ><%= new Date(booking.checkIn).toLocaleDateString('en-US', {
                  weekday: 'long', year: 'numeric', month: 'long', day:
                  'numeric' }) %></strong
                >
              </div>
              <div class="mb-3">
                <small class="text-muted">Check-out Date</small><br />
                <strong
                  ><%= new Date(booking.checkOut).toLocaleDateString('en-US', {
                  weekday: 'long', year: 'numeric', month: 'long', day:
                  'numeric' }) %></strong
                >
              </div>
              <div class="mb-3">
                <small class="text-muted">Number of Guests</small><br />
                <strong
                  ><%= booking.guests %> guest<%= booking.guests !== 1 ? 's' :
                  '' %></strong
                >
              </div>
              <div class="mb-3">
                <small class="text-muted">Total Nights</small><br />
                <strong
                  ><%= Math.ceil((new Date(booking.checkOut) - new
                  Date(booking.checkIn)) / (1000 * 60 * 60 * 24)) %> night<%=
                  Math.ceil((new Date(booking.checkOut) - new
                  Date(booking.checkIn)) / (1000 * 60 * 60 * 24)) !== 1 ? 's' :
                  '' %></strong
                >
              </div>
            </div>
            <div class="col-md-6">
              <h6>Payment Details</h6>
              <div class="mb-3">
                <small class="text-muted">Price per night</small><br />
                <strong
                  >₹<%= booking.listing.price.toLocaleString("en-IN") %></strong
                >
              </div>
              <div class="mb-3">
                <small class="text-muted">Total Amount</small><br />
                <strong class="text-primary fs-5"
                  >₹<%= booking.totalPrice.toLocaleString("en-IN") %></strong
                >
              </div>
              <div class="mb-3">
                <small class="text-muted">Payment Status</small><br />
                <span
                  class="badge bg-<%= booking.paymentStatus === 'paid' ? 'success' : booking.paymentStatus === 'pending' ? 'warning' : 'secondary' %>"
                >
                  <%= booking.paymentStatus.charAt(0).toUpperCase() +
                  booking.paymentStatus.slice(1) %>
                </span>
              </div>
              <div class="mb-3">
                <small class="text-muted">Booking Date</small><br />
                <strong
                  ><%= new Date(booking.createdAt).toLocaleDateString()
                  %></strong
                >
              </div>
            </div>
          </div>

          <% if(booking.specialRequests) { %>
          <div class="mt-4">
            <h6>Special Requests</h6>
            <p class="text-muted"><%= booking.specialRequests %></p>
          </div>
          <% } %>

          <!-- Action Buttons -->
          <div class="mt-4">
            <!-- Primary Actions Row -->
            <div class="row g-2 mb-3">
              <% if(booking.paymentStatus === 'pending') { %>
              <div class="col-md-6">
                <a
                  href="/bookings/<%= booking._id %>/payment"
                  class="btn btn-success btn-lg w-100 py-3"
                >
                  <i class="fas fa-credit-card me-2"></i> 
                  Pay Now - ₹<%= booking.totalPrice.toLocaleString("en-IN") %>
                </a>
              </div>
              <% } %>
              <% if(booking.status === 'pending' || booking.status === 'confirmed') { %>
              <div class="col-md-6">
                <button
                  type="button"
                  class="btn btn-outline-danger btn-lg w-100 py-3"
                  onclick="cancelBooking('<%= booking._id %>')"
                >
                  <i class="fas fa-times me-2"></i> Cancel Booking
                </button>
              </div>
              <% } %>
            </div>
            
            <!-- Secondary Actions Row -->
            <div class="row g-2">
              <div class="col-md-6">
                <a
                  href="/listings/<%= booking.listing._id %>"
                  class="btn btn-outline-primary w-100"
                >
                  <i class="fas fa-eye me-2"></i> View Listing
                </a>
              </div>
              <div class="col-md-6">
                <a href="/bookings" class="btn btn-outline-secondary w-100">
                  <i class="fas fa-arrow-left me-2"></i> Back to My Bookings
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function cancelBooking(bookingId) {
    if (confirm("Are you sure you want to cancel this booking?")) {
      fetch(`/bookings/${bookingId}`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
      }).then((response) => {
        if (response.ok) {
          window.location.href = "/bookings";
        } else {
          alert("Error cancelling booking");
        }
      });
    }
  }
</script>
